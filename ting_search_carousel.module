<?php
/**
 * @file
 * Ting search carousel module main file.
 */

/**
 * Implements hook_menu().
 */
function ting_search_carousel_menu() {
  $path = drupal_get_path('module', 'ting_search_carousel');
  $items = array();

  $items['admin/config/ting_search_carousel'] = array(
    'title' => 'Ting search carousel',
    'description' => '',
    'page callback' => 'ting_search_carousel_admin_page',
    'page arguments' => array(),
    'access arguments' => array('access administration pages'),
    'file' => 'ting_search_carousel.admin.inc'
  );

  $items['ting_search_carousel/results/ajax'] = array(
    'title' => 'Show search carousel results',
    'page callback' => 'ting_search_carousel_result',
    'access arguments' => array('access content'),
    'file' => 'ting_search_carousel.pages.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_block_info().
 */
function ting_search_carousel_block_info() {
  $blocks = array();

  $blocks['ting_search_carousel'] = array(
    'info' => 'Ting search carousel'
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function ting_search_carousel_block_view($delta) {
  $block = array();
  
  switch ($delta) {
    case 'ting_search_carousel':
      $searches = variable_get('ting_carousel_search_queries', array());
      $block['content'] = theme('ting_search_carousel', array('searches' => $searches));
      break;
  }

  return $block;
}

/**
 * Implements hook_theme().
 */
function ting_search_carousel_theme($existing, $type, $theme, $path) {
  $hooks = array();
  $hooks['ting_search_carousel'] = array(
    'variables' => array('searches' => NULL),
    'template' => 'ting_search_carousel'
  );

  $hooks['ting_search_carousel_collection'] = array(
    'variables' => array('collection' => NULL),
    'template' => 'ting_search_carousel_collection'
  );

  $hooks['ting_search_carousel_admin_form'] = array(
    'render element' => 'form',
  );

  return $hooks;
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function ting_search_carousel_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' || $module == 'panels') {
    return 'plugins/' . $plugin;
  }
}

/**
 * Implements hook_cron().
 */
function ting_search_carousel_cron() {
  ting_search_carousel_do_request(TRUE);
}

/**
 * Perform a ting search, retrieve covers and store some of data in cache.
 */
function ting_search_carousel_do_request($full = FALSE) {
  $search_queries = variable_get('ting_carousel_search_queries', array());
  $search_items = array();

  // There are any queries set.
  if (count($search_queries) > 0) {
    module_load_include('client.inc', 'ting');
    module_load_include('pages.inc', 'ting_covers');

    $service = new AdditionalInformationService(variable_get('addi_wsdl_url'), variable_get('addi_username'), variable_get('addi_group'), variable_get('addi_password'));
    $j = 0;

    // Search for each query up to 100 items.
    foreach ($search_queries as $item) {
      $result = '';
      
      if ($full) {
        $page = 1;
        $collections = array();
        while ($result = ting_do_search($item['query'], $page++, 50, array('facets' => array(), 'enrich' => TRUE, 'allObjects' => FALSE))) {
          if ($result->numTotalCollections == 0) {
            break;
          }

          $collections[] = $result;
        }

        $result = new stdClass();
        $result->collections = array();
        foreach ($collections as $collection) {
          foreach($collection->collections as $item) {
            $result->collections[] = $item;
          }
        }
      }
      else {
        $result = ting_do_search($item['query'], 1, 100, array('facets' => array(), 'enrich' => TRUE, 'allObjects' => FALSE));
      }
      
      // For each found collection, find a related item with cover.
      foreach ($result->collections as $collection) {
        foreach ($collection->reply->objects as $object) {
          dump_it($object->localId);
          $path = 'public://ting_search_carousel/' . md5($object->localId) . '.jpg';
          
          $ting_item_cover = '';
          $file = '';

          // If image is not present, try fetch it
          if (!file_exists($path)) {
            $ting_item_cover = $service->getByFaustNumber($object->localId);

            // No cover found, go to next item in collection
            if (count($ting_item_cover) == 0) {
              break;
            }

            $k = array_keys($ting_item_cover);
            $source_url = '';

            if ($ting_item_cover[$k[0]]->thumbnailUrl) {
              $source_url = $ting_item_cover[$k[0]]->thumbnailUrl;
            }
            elseif ($ting_item_cover[$k[0]]->detailUrl) {
              $source_url = $ting_item_cover[$k[0]]->detailUrl;
            }

            // Saves and returns new image file object
            $file = _ting_covers_pages_fetch_image('public://ting_search_carousel/' . md5($object->localId) . '.jpg', $source_url);
          }

          $item = new stdClass();
          $item->id = $object->id;
          $item->creator = isset($object->record['dc:creator']['oss:aut'][0]) ? $object->record['dc:creator']['oss:aut'][0] : '';
          $item->title = isset($object->record['dc:title'][''][0]) ? $object->record['dc:title'][''][0] : '';
          $item->image = image_style_url('ting_search_carousel', isset($file->uri) ? $file->uri : $path);

          $search_items[$j][] = $item;
          dump_it($item);
          break;
        }
      }

      $j++;
    }
  }

  

  // Clear & set the cache.
  cache_clear_all('ting_search_result', 'cache');
  cache_set('ting_search_result', serialize($search_items), 'cache');
}

/**
 * Implements hook_image_default_styles().
 */
function ting_search_carousel_image_default_styles() {
  $styles = array();

  $styles['ting_search_carousel'] = array(
    'name' => 'ting_search_carousel',
    'effects' => array(
      5 => array(
        'label' => 'Resize',
        'help' => 'Resizing will make images an exact set of dimensions. This may cause images to be stretched or shrunk disproportionately.',
        'effect callback' => 'image_resize_effect',
        'form callback' => 'image_resize_form',
        'summary theme' => 'image_resize_summary',
        'module' => 'image',
        'name' => 'image_resize',
        'data' => array(
          'width' => '112',
          'height' => '140',
        ),
        'weight' => '1',
      ),
    ),
  );

  return $styles;
}

function dump_it($s) {
  $f = drupal_get_path('module', 'ting_search_carousel') . '/dump.txt';
  $h = fopen($f, 'at');
  fwrite($h, print_r($s, TRUE) . ' - ' . date('d-m-Y H:i:s') . "\n");
  fclose($h);
}
