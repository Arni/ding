<?php
/**
 * @file
 * Code for the Ding library feature.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function ding_library_form_ding_library_node_form_alter(&$form, &$form_state) {
  if (isset($form['ding_library_slug'][$form['#node']->language])) {
    $form['ding_library_slug'][$form['#node']->language][0]['#element_validate'][] = 'ding_library_slug_validate';
  }
  elseif (isset($form['ding_library_slug']['und'])) {
    $form['ding_library_slug']['und'][0]['#element_validate'][] = 'ding_library_slug_validate';
  }
}

/**
 * Implements hook_ctools_plugin_directory -
 */
function ding_library_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'ctools' && $plugin_type == 'content_types') {
    return 'plugins/content_types';
  }
}

/**
 * Custom validate handler for the slug field.
 *
 * Don't allow charecters that aren't URL friendly, such as # , etc.
 */
function ding_library_slug_validate(&$form, &$form_state) {
  // Try to get the slug value.
  if (isset($form_state['values']['ding_library_slug'][$form_state['node']->language])) {
    $slug = $form_state['values']['ding_library_slug'][$form_state['node']->language][0]['value'];
  }
  elseif (isset($form_state['values']['ding_library_slug']['und'])) {
    $slug = $form_state['values']['ding_library_slug']['und'][0]['value'];
  }

  // If we found the slug do the actual validation.
  if (!empty($slug)) {
    if (!(preg_match('/^[a-z0-9_\-]+$/', $slug))) {
      form_set_error(implode('][', $form['#parents']), t('Illeagal charecters detected, only small letters (a-z), numbers (0-9), dashes (-) and underscores (_) allowed'));
    }
  }
}

/**
 * Implements hook_views_data_alter().
 */
function ding_library_views_data_alter(&$data) {
  foreach (field_info_fields() as $name => $field) {
    $name = 'field_data_' . $name;
    if ($field['type'] == 'group') {
      foreach ($data[$name] as $column => $views_data) {
        if (strpos($column, 'gid') !== FALSE) {
          $data[$name]['ding_library_nid'] = $views_data;
          unset($data[$name]['ding_library_nid']['filter']);
          unset($data[$name]['ding_library_nid']['sort']);
          $data[$name]['ding_library_nid']['title'] = str_replace('gid', 'nid', $data[$name]['ding_library_nid']['title']);
          $data[$name]['ding_library_nid']['title short'] = str_replace('gid', 'nid', $data[$name]['ding_library_nid']['title short']);
          $data[$name]['ding_library_nid']['argument']['handler'] = 'ding_library_nid_to_gid_argument';
        }
      }
    }
  }
}

include_once('ding_library.features.inc');
