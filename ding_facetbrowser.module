<?php

/**
 * Implements hook_block_info()
 */
function ding_facetbrowser_block_info() {
  $blocks['facetbrowser'] = array(
    'info'  => t('Facet browser'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

/**
 * Implements hook_theme()
 */
function ding_facetbrowser_theme() {
  return array(
   'facetbrowser' => array(
      'variables' => array('facets' => NULL),
    ),
  );
}

/**
 * Implements a custom facetbrowser form
 */
function ding_facetbrowser_form($form, &$form_state, $facets = FALSE) {
  $predefined_facet_string = !empty($_GET['facets']) ? $_GET['facets'] : FALSE;
  $predefined_facets       = explode(';', $predefined_facet_string);
  $set_facets              = array();
  $checkboxes              = array();
  $default_values          = array();

  // Create an array with pre-set facets from page url
  foreach ($predefined_facets as $pre_facet) {
    if ($pre_facet) {
      $explode_facet = explode(':', $pre_facet);
      $set_facets[str_replace('facet.', '', $explode_facet[0])][$explode_facet[1]] = $explode_facet[1];
    }
  }
  if (count($facets) == TRUE) {
    foreach ($facets as $facet) {
      if (count($facet) == TRUE)
        $form[$facet->name] = array(
          '#type'        => 'fieldset',
          '#title'       => $facet->name,
          '#collapsible' => TRUE,
        );
      if ($facet instanceof TingClientFacetResult && count($facet->terms) == TRUE) {
        foreach ($facet->terms as $term_name => $term_count) {
          $facet_name             = explode('.', $facet->name);
          $element_name           = end($facet_name);
          $checkboxes[$term_name] = $term_name . ' (' . $term_count . ')';

          if (array_key_exists($element_name, $set_facets) && array_key_exists($term_name, $set_facets[$element_name])) {
            $default_values[] = $term_name;
          }
        }
        $form[$facet->name][$element_name] = array(
          '#type'          => 'checkboxes',
          '#options'       => $checkboxes,
          '#default_value' => $default_values,
        );
      }
      // Dont show empty facet categories
      elseif (!empty($facet->name) && array_key_exists($facet->name, $form)) {
        unset($form[$facet->name]);
      }

      // Reset previous set variables
      $checkboxes     = array();
      $default_values = array();
    }

    $form['submit'] = array(
      '#type'  => 'submit',
      '#value' => 'Submit',
    );
  }

  return $form;
}

/**
 * Implements a validate handler for ding_facetbrowser_form().
 */
function ding_facetbrowser_form_validate($form, &$form_state) {
}

/**
 * Implements a submit handler for ding_facetbrowser_form()
 */
function ding_facetbrowser_form_submit($form, &$form_state) {
  $facets = array();
  $string = FALSE;

  if (!empty($form_state['values']) && is_array($form_state['values'])) {
    foreach ($form_state['values'] as $name => $data) {
      if (is_array($data)) {
        foreach ($data as $key => $value) {
          if ($value == TRUE) {
            $string .= 'facet.' . $name . ':' . $value . ';';
          }
        }
      }
    }
  }

  drupal_goto(implode('/', arg()), array('query' => array('facets' => $string)));
}


/**
 * facetbrowser theme function
 */
function theme_facetbrowser($all_facets = FALSE) {
  $output   = ' ';
  $elements = array();

  if (is_array($all_facets)) {
        $elements[] = drupal_render(drupal_get_form('ding_facetbrowser_form', $all_facets));
  }
  return implode('', $elements);
}


/**
 * Implements hook_block_view()
 *
 * @return Array
 */
function ding_facetbrowser_block_view($delta = FALSE) {
  $block = array();
  $block_content = FALSE;
  drupal_add_js(drupal_get_path('module', 'ding_facetbrowser') . '/js/jquery-bbq/jquery.ba-bbq.js');
  drupal_add_js(drupal_get_path('module', 'ding_facetbrowser') . '/js/facetbrowser.js');
  drupal_add_css(drupal_get_path('module', 'ding_facetbrowser') . '/css/facetbrowser.css');

  # TODO: Fix so only the correct module is invoked
  foreach (module_implements('ding_facetbrowser') as $module) {
    $result = module_invoke($module, 'ding_facetbrowser');
    if (count($result->facets) == TRUE || $result->show_empty == TRUE) {
      $block_content = theme('facetbrowser', $result->facets);
      break;
    }
  }

  switch ($delta) {
    case 'facetbrowser':
      $block['subject'] = t('Facet browser');
      $block['content'] = $block_content;
    break;
  }

  return $block;
}


/**
 * Implements hook_ding_facetbrowser() from the apachesolr_search module
 * to prevent from hacking in contrib module.
 */
function apachesolr_search_ding_facetbrowser() {
  $return_object = new stdClass();
  $facets = $facet_terms = array();
  $fields = array(
    1 => 'tags',
    2 => 'category',
  );

  if (apachesolr_has_searched()) {
    $results = _apachesolr_static_result();
    foreach ($results as $result) {
      $node = node_load($result->nid);
      if ($node instanceof stdClass) {
        foreach ($fields as $vocab_id => $vocab_name) {
          $field_name = 'field_' . $vocab_name;
          if (is_array($node->$field_name) && count($node->$field_name) == TRUE) {
            foreach ($node->$field_name as $taxonomy) {
              if (is_array($taxonomy)) {
                foreach ($taxonomy as $term) {
                  $term_data = taxonomy_term_load_multiple(array($term['tid']));
                  $facet_terms[$vocab_name][$term_data[$term['tid']]->name] = $term_data[$term['tid']]->name;
                }
                $facets[$vocab_name] = (object)array(
                  'name'  => $field_name,
                  'terms' => $facet_terms[$vocab_name],
                );
              }
            }
          }
        }
      }
    }
  }
  $return_object->facets = $facets;
  $return_object->show_empty = FALSE;
  return $return_object;
}

/**
 * Implements hook_apachesolr_search_result_alter().
 *
 * Save the search result in a static variable to be able to use it in blocks and so on.
 */
function ding_facetbrowser_apachesolr_search_result_alter(&$doc) {
  _apachesolr_static_result($doc);
}

/*
 * Save the search result as in static variable
 */
function _apachesolr_static_result($result = FALSE) {
  static $search_result = array();
  if ($result instanceof stdClass) {
    $search_result[] = $result;
  }
  return $search_result;
}
