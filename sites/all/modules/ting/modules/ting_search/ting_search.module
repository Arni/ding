<?php
// $Id$

/**
 * @file ting_search.module
 * Displays facet browser and search results from the Ting database.
 */

/**
 * Implementation of hook_theme().
 */
function ting_search_theme() {
  return array(
    'ting_search' => array(
      'arguments' => array('result' => NULL),
      'template' => 'ting_search'
    ),
    'ting_record' => array(
      'arguments' => array('record' => NULL),
      'template' => 'ting_record'
    ),
    'ting_facet_browser' => array(
      'arguments' => array('result' => NULL),
      'function' => 'ting_search_facet_browser'
    ),
  );
}

function ting_search_menu() {
	return array(
		'ting_search' => array(
	    'title' => 'Ting search results',
	    'description' => 'Lists facets and search results from the Ting database as HTML or JSON.',
	    'access arguments' => array('search content'),
			'page callback' => 'ting_search_page',
	    'file' => 'ting_search.pages.inc',
		),
	);
}

function ting_search_facet_browser($result)
{
	//Add base Prototype files for enhanced OOP
	drupal_add_js(drupal_get_path('module', 'ting_search') .'/js/prototype/object.js', 'module');
	drupal_add_js(drupal_get_path('module', 'ting_search') .'/js/prototype/enumerable.js', 'module');
	
	//Add Pure JS templating engine
	drupal_add_js(drupal_get_path('module', 'ting_search') .'/js/pure/js/pure.js', 'module');
	//drupal_add_js(drupal_get_path('module', 'ding_ting_search_result') .'/js/pure/js/purePacked.js', 'module');

	//Add jQuery Url plugin
	drupal_add_js(drupal_get_path('module', 'ting_search') .'/js/jquery.url/jquery.url.js', 'module');
	//drupal_add_js(drupal_get_path('module', 'ding_ting_search_result') .'/js/jquery.url/jquery.url.packed.js', 'module');
	
	drupal_add_js(drupal_get_path('module', 'ting_search') .'/js/ting_facet_browser.js', 'module');
	drupal_add_css(drupal_get_path('module', 'ting_search') .'/css/ting_facet_browser.css', 'module');

	drupal_add_js(array('tingResult' => array(
												'recordTemplate' => ting_search_render_record_template(),
												'resizeButtonText' => t('Show more facet terms'))), 
								'setting');
	
	return '<div id="ting-facet-browser">
					</div>	
					<script type="text/javascript">
						jQuery(function() { Drupal.tingFacetBrowser("#ting-facet-browser",'.json_encode($result).'); });
					</script>';
}

function ting_search_render_record_template()
{
	$record = new TingClientRecord();
	$record->id = 'id';
	
	$data = new TingClientDublinCoreData();
	foreach ($data as $attribute => $value)
	{
		$data->$attribute = array($attribute);
	}
	$record->data = $data;
	
	return theme('ting_record', $record);	
}
