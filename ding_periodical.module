<?php

/**
 * @file
 * Shows issue information on periodicals.
 */

// Load Field module hooks.
module_load_include('inc', 'ding_periodical', 'ding_periodical.field');

/**
 * Implements hook_theme().
 */
function ding_periodical_theme() {
  return array(
    'ding_periodical_issues' => array(
      'variables' => array(
        'entity' => NULL,
        'issues' => array(),
        'availability' => array(),
      ),
    ),
  );
}

/**
 * Theming function.
 */
function theme_ding_periodical_issues($variables) {
  $items = array();

  foreach ($variables['issues'] as $volume => $issues) {
    $iss = array();
    $i = 0;

    foreach ($issues as $key => $availability) {
      $issue = $key;
      $issue_id = $availability['local_id'];

      $normalized_id = md5($issue_id);

      // Build table with holding information for the current volume.
      $holding_data = ding_periodical_build_table($availability);

      // Check if the volume is reservable and add reservation form.
      if (!empty($issue_id)) {
        $reservation = new DingPeriodicalReservable($issue_id, $volume, $key, $variables['entity']);
        $form = ding_provider_get_form('ding_reservation_reserve_form', $reservation, TRUE);
        $holding_data .= drupal_render($form);
      }

      $holdings = array(
        array(
          'data' => '<div class="periodical-holdings">' . $holding_data . '</div>',
        )
      );

      // Normal behavior - periodicals, dc.type=tidsskrift.
      $iss[$i] = array(
        'data' => '<span id="periodical-id-' . $normalized_id . '" class="' . drupal_html_class('ding_periodical_fold') . ' ding-reservable-periodical periodical-id-' . $normalized_id . '">' . $issue . '</span>',
        'class' => array(
          drupal_html_class('ding-periodical-container'),
        ),
      );

      // Suppose we have dc.type=Ã¥rbog, where keys for those periodicals are
      // empty.
      if (empty($issue)) {
        $iss[$i]['data'] = $holdings[0]['data'];
        $iss[$i]['class'][] = drupal_html_class('ding-periodical-no-issues');
        $iss[$i]['class'][] = drupal_html_class('ding-reservable-periodical');
        $iss[$i]['id'][] = drupal_html_id('periodical-id-' . $normalized_id);
      }
      else {
        // Set children with holding information for periodicals.
        $iss[$i]['children'] = $holdings;
      }

      $i++;
    }

    $vol = array(
      'data' => '<div class="' . drupal_html_class('ding_periodical_fold') . '">' . $volume . '</div>',
      'children' => $iss,
      'class' => array(drupal_html_class('ding_periodical_foldable')),
    );

    $items[] = $vol;
  }

  return theme('item_list', array('items' => $items, 'attributes' => array('class' => drupal_html_class('ding_periodical_issues'))));
}

/**
 * Build a markup for the availability table.
 *
 * @param $issue
 *   Issue array, with keys:
 *   - local_id: Periodical identifier.
 *   - provider: Provider identifier, 'alma' here.
 *   - placement: Item placement info.
 *     - location: Actual location string.
 *     - ordered_count
 *     - checked_out_count
 *     - reference_count
 *     - total_count
 *     - available_count
 *     - reservable
 *
 * Keys checked_out_count, reference_count, ordered_count
 * appear only in alma.
 *
 * @todo
 *   This table DOES NOT contain the reservations count,
 *   since this number comes as a separate value, for the whole
 *   ting item, not the periodicals.
 *
 * @return
 *   HTML markup for the availability table.
 */
function ding_periodical_build_table($availability) {
  $header = array(
    'placement' => t('Placement'),
    'copies' => t('Copies'),
    'home' => t('At home'),
  );

  $rows = array();

  if ($availability['provider'] === 'alma') {
    $header['not_for_loan'] = t('Not for loan');
    $header['checked_out'] = t('Checked out');
  }

  $i = 0;
  foreach ($availability['placement'] as $placement) {
    $rows[$i] = array(
      $placement['location'],
      $placement['total_count'],
      $placement['available_count'],
    );

    if ($availability['provider'] === 'alma') {
      $rows[$i][] = $placement['reference_count'];
      $rows[$i][] = $placement['checked_out_count'];
    }

    $i++;
  }

  return theme('table', array('header' => $header, 'rows' => $rows));
}
