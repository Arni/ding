<?php

/**
 * @file
 * Shows issue information on periodicals.
 */

// Load Field module hooks.
module_load_include('inc', 'ding_periodical', 'ding_periodical.field');

drupal_add_css(drupal_get_path('module', 'ding_periodical') . '/css/ding_periodical.css');

/**
 * Implements hook_theme().
 */
function ding_periodical_theme() {
  return array(
    'ding_periodical_issues' => array(
      // 'variables' => array('entity', 'issues'),
      'render element' => 'elements',
    ),
  );
}

/**
 * Theming function.
 */
function theme_ding_periodical_issues($variables) {
  $items = array();

  foreach ($variables['elements']['#issues'] as $volume => $issues) {
    $iss = array();
    $i = 0;

    foreach ($issues as $key => $availability) {
      $issue = $key;
      $issue_id = '';
      if (isset($availability['local_id'])) {
        $issue_id = $availability['local_id'];
      }
      elseif (isset($availability['reservable'])) {
        $issue_id = $availability['reservable'];
      }

      $normalized_id = md5($issue_id);
      // @todo
      // This is to be refactored to prevent segfaults.
      if (!empty($issue_id) && module_exists('ding_periodical_reservation')) {
        $_SESSION['ding_periodical_reservation'][$normalized_id] = array(
          'issue_id' => $issue_id,
          'volume' => $volume,
          'key' => $key,
          'entity' => $variables['elements']['#entity'],
        );
      }

      $holding_data = ding_periodical_holding_data($variables['elements']['#entity']->localId);
      $holding_data .= '<div class="periodical-reserve"><button>' . t('Reserve') . '</button></div>';

      $holding = array(array(
        'data' => '<div class="periodical-holdings">' . $holding_data . '</div>',
      ));

      // Normal behavior - periodicals, dc.type=tidsskrift.
      $iss[$i] = array(
        'data' => '<span id="periodical-id-' . $normalized_id . '" class="' . drupal_html_class('ding_periodical_fold') . ' ding-reservable-periodical periodical-id-' . $normalized_id . '">' . $issue . '</span>',
        'children' => $holding,
        'class' => array(
          drupal_html_class('ding-periodical-container'),
        ),
      );

      // Suppose we have dc.type=Ã¥rbog
      // Keys for those periodicals are empty.
      if (empty($issue)) {
        $iss[$i]['data'] = $holding[0]['data'];
        $iss[$i]['class'][] = drupal_html_class('ding-periodical-no-issues');
        $iss[$i]['class'][] = drupal_html_class('ding-reservable-periodical');
        $iss[$i]['id'][] = drupal_html_id('periodical-id-' . $normalized_id);
        unset($iss[$i]['children']);
      }

      $i++;
    }

    $vol = array(
      'data' => '<div class="' . drupal_html_class('ding_periodical_fold') . '">' . $volume . '</div>',
      'children' => $iss,
      'class' => array(drupal_html_class('ding_periodical_foldable')),
    );

    $items[] = $vol;
  }

  return theme('item_list', array('items' => $items, 'attributes' => array('class' => drupal_html_class('ding_periodical_issues'))));
}

/**
 * Fetch periodicals availability data.
 *
 * @param $item
 *   Ting object local id, parent of periodicals.
 * @return type
 *   HTML markup.
 */
function ding_periodical_holding_data($item) {
  $holdings = &drupal_static(__FUNCTION__, array());
  if (!isset($holdings[$item]['html'])) {
    $holdings = ding_provider_invoke('availability', 'holdings', array($item));
  }

  return $holdings[$item]['html'];
}
