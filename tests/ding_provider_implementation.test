<?php

/**
 * @file
 * Test provider implementation.
 */

class DingProviderImplementationTestCase extends DrupalWebTestCase {

  function setUp($modules) {
    $this->profile = 'ding2';
    if (!in_array('ding_provider', $modules)) {
      $modules[] = 'ding_provider';
    }
    parent::setUp($modules);
  }

}

abstract class DingUserProviderImplementationTestCase extends DingProviderImplementationTestCase {

  abstract function getGoodUser();

  function testAuthenticate() {
    list($name, $pass) = $this->getGoodUser();
    $res = ding_provider_invoke('user', 'authenticate', $name, $pass);
    $this->assertTrue($res['success'], t('Authentication works.'));
    $diff = array_diff_key($res, array('success' => 1, 'creds' => 1, 'user' => 1));
    $this->assertTrue(empty($diff), t('No unknown keys in result.'));

    if (isset($res['user'])) {
      $this->assertTrue(is_array($res['user']), t('User key is an array.'));
    }

    if (isset($res['creds'])) {
      if (ding_provider_implements('user', 'is_authenticated')) {
        $this->assertTrue(ding_provider_invoke('user', 'is_authenticated', $res['creds']), t('is_authenticated returns TRUE'));
      }
      else {
        debug('is_authenticated is not implemented, assuming that presence of creds signifies that the user is logged in.');
      }
    }
    else {
      debug('Creds not set.');
    }
  }
}