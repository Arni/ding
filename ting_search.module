<?php

/**
 * @file
 * Enables search integration with Ting.
 */

/**
 * Implements hook_ctools_plugin_directory().
 *
 * It simply tells panels where to find the .inc files that define various
 * args, contexts, content_types.
 */
function ting_search_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' && !empty($plugin)) {
    return "plugins/$plugin";
  }
}

/**
 * Implement hook_ctools_plugin_api().
 */
function ting_search_ctools_plugin_api($module, $api) {
  if ($module == 'page_manager' && $api == 'pages_default') {
    return array('version' => 1);
  }
}
/**
 * Implements hook_menu_alter().
 *
 * Temporary hack to alter titles.
 */
function ting_search_menu_alter(&$items) {
  $items['search/node']['title'] = 'Hjemmeside';
  $items['search/node/%menu_tail']['title'] = 'Hjemmeside';
  $items['search/ting']['title'] = 'Brønd';
  $items['search/ting/%menu_tail']['title'] = 'Brønd';
  $items['search/meta']['title'] = 'Universal Search';
  $items['search/meta/%menu_tail']['title'] = 'Universal Search';
}

/**
 * Implements hook_search_info().
 */
function ting_search_search_info() {
  return array(
    'title' => t('Ting'),
    'path' => 'ting',
    'conditions_callback' => 'ting_search_conditions_callback',
  );
}

/**
 * Implements hook_ding_facetbrowser().
 */
function ting_search_ding_facetbrowser() {
  $results             = new stdClass();
  $results->show_empty = FALSE;
  $search_result       = drupal_static('ting_search_results');
  if ($search_result) {
    $results->facets     = ($search_result instanceof TingClientSearchResult) ? $search_result->facets : array();
    $results->searchkey  = $search_result->search_key;
    return $results;
  }
}

/**
 * Implements hook_entity_info_alter().
 */
function ting_search_entity_info_alter(&$entity_info) {
  $entity_info['ting_collection']['view modes'] += array(
    'search_result' => array(
      'label' => t('Search result'),
      'custom settings' => FALSE,
    ),
  );
}

/**
 * Implements hook_theme().
 */
function ting_search_theme() {
  return array(
    'ting_search_results' => array(
      'variables' => array('results' => NULL, 'module' => NULL),
      'file'      => 'ting_search.pages.inc',
      'template'  => 'ting-search-results',
    ),
    'ting_search_mini_pager' => array(
      'variables' => array('tags' => array(), 'element' => 0, 'parameters' => array(), 'quantity' => 9),
    ),
    'ting_search_display_extended_query' => array(
      'variables' => array('query_label'=>NULL,'query_string' => NULL),
      'template' => 'ting-search-display-extended-query',
    ),
  );
}

function ting_search_get_extended_actions() {
  return theme('ting_search_extended_search');
}

function ting_search_extended_search_variables() {
  return array();
}


/**
 * @brief Implementation of hook_form_FORM_ID_alter() for form search_block_form.
 */
function ting_search_form_search_block_form_alter(&$form, &$form_state, $form_id) {
  $advanced_fields = array(
    'dc.creator' => array(
      'key' => 'creator',
      'title' => t('Author'),
      'description' => t('Enter the author name'),
    ),
    'dc.title' => array(
      'key' => 'title',
      'title' => t('Title'),
      'description' => t('Enter title'),
    ),
    'dc.subject' => array(
      'key' => 'subject',
      'title' => t('Subject'),
      'description' => t('Enter subject keywords'),
    ),
  );
  $advanced = TRUE;

  // Parse extended search query parameters.
  if (arg(0) == 'search') {
    $parts = explode('/', $_GET['q']);
    // Lose 'search' and the search type.
    array_shift($parts);
    $type = array_shift($parts);
    $search_query = implode('/', $parts);
    $indexes = ting_search_extract_keys($search_query, array_keys($advanced_fields));
    $search_query = $indexes['q'];
    unset($indexes['q']);
    if ($type != 'ting' and !empty($indexes)) {
      $search_query .= " " . implode(' ', $indexes);
      $indexes = array();
      $advanced = FALSE;
    }

    $form['search_block_form']['#default_value'] = $search_query;
  }

  $form['sort'] = array(
    '#type' => 'hidden',
    '#default_value' => isset($_GET['sort']) ? check_plain($_GET['sort']) : FALSE,
    '#attributes' => array('id' => 'controls_search_sort'),
  );
  $form['size'] = array(
    '#type' => 'hidden',
    '#default_value' => isset($_GET['size']) ? (int)$_GET['size'] : FALSE,
    '#attributes' => array('id' => 'controls_search_size'),
  );

  $form['form_id']['#suffix'] = ting_search_get_extended_actions();

  if ($advanced) {
    $form['advanced'] = array(
      '#type' => 'fieldset',
      '#title' => t('Advanced search'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#attached' => array(
        'css' => array(
          drupal_get_path('module', 'ting_search') . '/ting_search_extendform.css',
        ),
        'js' => array(
          drupal_get_path('module', 'ting_search') . '/ting_search_extendform.js',
        ),
      ),
    );

    $expand = FALSE;
    foreach ($advanced_fields as $name => $field) {
      $form['advanced'][$field['key']] = array(
        '#type' => 'textfield',
        '#title' => $field['title'],
        '#size' => 30,
        '#maxlength' => 64,
        '#description' => $field['description'],
        '#default_value' => isset($indexes[$name]) ? $indexes[$name] : '',
      );
      if (isset($indexes[$name]) && !empty($indexes[$name])) {
        $expand = TRUE;
      }
    }
    if ($expand) {
      // @todo Remove this when the advanced search summary is in place.
      $form['advanced']['#collapsed'] = FALSE;
    }

  }
  $form['#submit'] = array('ting_search_submit');

  return $form;
}

/**
 * Extract special field keys from search string.
 *
 * @param string $search_query The search query.
 * @param array $keys Keys to extract.
 *
 * @return array Where the array keys are the search keys, and the remainder
 *   search string in 'q'.
 */
function ting_search_extract_keys($search_query, $keys) {
  $indexes = &drupal_static('ting_search_extract_indexes', array());

  ting_search_extract_indexes(NULL, $keys);
  /*
   * We'll just use three regexps, instead of trying to construct One Regexp
   * To rule Them All.
   */
  $regexpes = array(
    '/\s+and\s+\((?P<subexpr>[^)]+)\)/i',
    '/\s+and\s+(?P<subexpr>[^=]+=([' . "'" . '"])[^\2]+\2)/i',
    '/\s+and\s+(?P<subexpr>[^=]+=\S+)/i',
  );
  foreach ($regexpes as $regexp) {
    $search_query = preg_replace_callback($regexp, 'ting_search_extract_indexes', $search_query);
  }

  $indexes['q'] = $search_query;
  return $indexes;
}

/**
 * preg_replace_callback function.
 */
function ting_search_extract_indexes($matches, $set_keys = NULL) {
  static $keys;
  if ($set_keys) {
    $keys = array_flip($set_keys);
  }
  $indexes = &drupal_static(__FUNCTION__, array());
  if (preg_match('/^(?P<index>[^=]+)\=(?P<value>.*)$/', $matches['subexpr'], $rx) && array_key_exists(trim($rx['index']), $keys)) {
    $indexes[trim($rx['index'])] = trim($rx['value']);
    return '';
  }
  return $matches[0];
}

/**
 * Search conditions callback.
 */
function ting_search_conditions_callback($keys) {
  $conditions = array();

  if (!empty($_REQUEST['keys'])) {
    $conditions['keys'] = check_plain($_REQUEST['keys']);
  }

  if (!empty($_REQUEST['size'])) {
    $conditions['size'] = (int)$_REQUEST['size'];
  }


  if (!empty($_REQUEST['sort'])) {
    $conditions['sort'] = check_plain($_REQUEST['sort']);
  }

  // If facets is set, check if we have to remove any, if so,
  // reload the page.
  if (!empty($_REQUEST['facets'])) {
    $remove = array();
    $redirect = FALSE;
    foreach ($_REQUEST['facets'] as $key => $facet) {
      if (preg_match('/^-facet/', $facet)) {
        $remove[] = preg_replace('/^-/', '', $facet);
        $redirect = TRUE;
        unset($_REQUEST['facets'][$key]);
      }
    }

    foreach ($_REQUEST['facets'] as $key => $facet) {
      foreach ($remove as $rem) {
        if ($facet == $rem) {
          unset($_REQUEST['facets'][$key]);
          continue;
        }
      }
    }
    $conditions['facets'] = $_REQUEST['facets'];
    $url = explode('?', request_uri());
    if ($redirect === TRUE) {
      $facets = array();
      foreach ($conditions['facets'] as $facet) {
        $facets['facets'][] =  $facet;
      }
      drupal_goto(rawurldecode(substr($url[0],1)), array('query' => $facets));
    }
  }
  return $conditions;
}

/**
 * Implements hook_search_execute().
 */
function ting_search_search_execute($keys = NULL, $conditions = NULL) {
  // TODO: Set sort options
  $options    = array();
  $results    = array();
  $facetArray = array();
  $query      = '(' . $keys . ')';
  $options['numFacets'] = 25;
  module_load_include('client.inc', 'ting');
   //Extend query with selected facets
  if (isset($conditions['facets']) && $conditions['facets'] != NULL) {
    $facets = $conditions['facets'];
    foreach ($facets as $facet) {
      $facet = explode(':', $facet, 2);
      if ($facet[0]) {
        $facetArray[] = $facet[0] . '="' . rawurldecode($facet[1]) . '"';
      }
    }

    $query .= ' AND ' . implode(' AND ', $facetArray);
  }
  try {
    $page = pager_find_page();

    $resultsPerPage = variable_get('ting_search_results_per_page', 10);
    if (!empty($conditions['size'])) {
      $resultsPerPage = $conditions['size'];
    }

    if (!empty($conditions['sort'])) {
      $options['sort'] = $conditions['sort'];
    }

    $searchResult = ting_do_search($query, $page + 1, $resultsPerPage, $options);
    if (isset($searchResult->collections)) {
      $searchResult->search_key = $keys;

      $total_results = (int) $searchResult->numTotalObjects;

      pager_default_initialize($total_results, $resultsPerPage);

      foreach ($searchResult->collections as &$collection) {
        $build = ting_collection_view($collection, 'teaser');
        $uri = entity_uri('ting_collection', $collection);
        $results[] = array(
          'link' => url($uri['path'], $uri['options']),
          'type' => '',
          'title' => $collection->title,
          'user' => '',
          'date' => '',
          'snippet' => drupal_render($build),
        );
      }
    }
  }
  catch (TingClientException $e) {
    // TODO: Log the error.
    $results = array();
  }

  drupal_static('ting_search_results', $searchResult);

  return $results;
}

/**
 * Implements hook_search_page().
 */
function ting_search_search_page($results) {
  return array(
    '#theme' => 'ting_search_results',
    '#results' => $results,
    '#module' => 'ting_search',
  );
}

/**
 * Theme a mini pager with only first, previous and next links.
 */
function theme_ting_search_mini_pager($variables) {
  $tags = $variables['tags'];
  $element = $variables['element'];
  $parameters = $variables['parameters'];
  $quantity = $variables['quantity'];
  global $pager_page_array, $pager_total;

  // Calculate various markers within this pager piece:
  // Middle is used to "center" pages around the current page.
  $pager_middle = ceil($quantity / 2);
  // current is the page we are currently paged to
  $pager_current = $pager_page_array[$element] + 1;
  // max is the maximum page number
  $pager_max = $pager_total[$element];
  // End of marker calculations.


  $li_previous = theme('pager_previous', array('text' => (isset($tags[1]) ? $tags[1] : t('‹ previous')), 'element' => $element, 'interval' => 1, 'parameters' => $parameters));

  if (empty($li_previous)) {
    $li_previous = "&nbsp;";
  }

  $li_first = theme('pager_first', array('text' => (isset($tags[0]) ? $tags[0] : t('« first')), 'element' => $element, 'parameters' => $parameters));

  if (empty($li_first)) {
    $li_first = "&nbsp;";
  }

  $li_next = theme('pager_next', array('text' => (isset($tags[3]) ? $tags[3] : t('next ›')), 'element' => $element, 'interval' => 1, 'parameters' => $parameters));
  if (empty($li_next)) {
    $li_next = "&nbsp;";
  }

  if ($pager_total[$element] > 1) {
    $items[] = array(
      'class' => array('pager-first'),
      'data' => $li_first,
    );

    $items[] = array(
      'class' => array('pager-previous'),
      'data' => $li_previous,
    );

    $items[] = array(
      'class' => array('pager-next'),
      'data' => $li_next,
    );
    return theme('item_list', array('items' => $items, 'type' => 'ul', 'attributes' => array('class' => array('pager'))));
  }
}


/**
 * Implements hook_block_info().
 */
function ting_search_block_info() {
  $blocks['search-controls'] = array(
      'info' => t('Ting search "sort by" and "records per page"'),
      'cache' => DRUPAL_CACHE_PER_PAGE,
    );
  $blocks['search-display-extended-query'] = array(
      'info' => t('Ting search extended query display'),
      'cache' => DRUPAL_CACHE_PER_PAGE,
    );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function ting_search_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'search-controls':
      drupal_add_css(drupal_get_path('module', 'ting_search') . '/ting_search_extendform.css');
      drupal_add_js(drupal_get_path('module', 'ting_search') . '/ting_search_extendform.js');
      $block['subject'] = t('Ting search controls');
      $block['content'] = search_controls_content() ;
      break;
    case 'search-display-extended-query':
      drupal_add_css(drupal_get_path('module', 'ting_search') . '/ting_search_extendform.css');
      drupal_add_js(drupal_get_path('module', 'ting_search') . '/ting_search_extendform.js');
      $block['content'] = theme('ting_search_display_extended_query', array('query_label'=>t('Your query:'),'query_string'=>NULL));
      break;
  }
  return $block;

}


/**
 * @brief Implementation of hook_form_FORM_ID_alter() for form ting_admin_register_settings.
 * @brief Add author, title & subject to ting_admin_register_settings.
 */
function ting_search_form_ting_admin_register_settings_alter(&$form, &$form_state, $form_id) {
  $form['ting_search_extendform_creator_index'] = array(
    '#type' => 'textfield',
    '#title' => t('Author'),
    '#description' => t('Field that contains authername, for instance dc.creator'),
    '#default_value' => variable_get('ting_search_extendform_creator_index', 'dc.creator')
  );

  $form['ting_search_extendform_title_index'] = array(
    '#type' => 'textfield',
    '#title' => t('Title'),
    '#description' => t('Field that contains title, for instance dc.title'),
    '#default_value' => variable_get('ting_search_extendform_title_index', 'dc.title')
  );

  $form['ting_search_extendform_subject_index'] = array(
    '#type' => 'textfield',
    '#title' => t('Subject'),
    '#description' => t('Field that contains subject, for instance dc.subject'),
    '#default_value' => variable_get('ting_search_extendform_subject_index', 'dc.subject')
  );

  $form['#validate'][] = 'ting_search_admin_register_settings_validate';
  $form['#submit'][] = 'ting_search_admin_register_settings_submit';

  return $form;
}


function ting_search_admin_register_settings_validate($form, &$form_state) {
  $s = '';
  if (isset($form_state['values']['ting_search_extendform_creator_index'])) {
    $s = $form_state['values']['ting_search_extendform_creator_index'];
  }
  if ($s == '') {
    form_set_error('ting_search_extendform_creator_index', t('Please enter a register to use with creator.'));
  }

  $s = '';
  if (isset($form_state['values']['ting_search_extendform_title_index'])) {
    $s = $form_state['values']['ting_search_extendform_title_index'];
  }
  if ($s == '') {
    form_set_error('ting_search_extendform_title_index', t('Please enter a register to use with title.'));
  }

  $s = '';
  if (isset($form_state['values']['ting_search_extendform_subject_index'])) {
    $s = $form_state['values']['ting_search_extendform_subject_index'];
  }
  if ($s == '') {
    form_set_error('ting_search_extendform_subject_index', t('Please enter a register to use with subjects.'));
  }
}


function ting_search_admin_register_settings_submit($form, $form_state) {
  variable_set('ting_search_extendform_creator_index', $form_state['values']['ting_search_extendform_creator_index']);
  variable_set('ting_search_extendform_title_index', $form_state['values']['ting_search_extendform_title_index']);
  variable_set('ting_search_extendform_subject_index', $form_state['values']['ting_search_extendform_subject_index']);
}


function search_extend_content() {
  return drupal_get_form('search_extend_form');
}

function search_extend_form($form_state) {
  $form['extendform'] = array(
    '#type' => 'fieldset',
    '#title' => t('Advanced search'),
    '#tree' => TRUE,
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );
  $form['extendform']['creator'] = array(
    '#type' => 'textfield',
    '#title' => t('Author'),
    '#size' => 30,
    '#maxlength' => 64,
    '#description' => t('Enter the author name'),
  );
  $form['extendform']['title'] = array(
    '#type' => 'textfield',
    '#title' => t('Title'),
    '#size' => 30,
    '#maxlength' => 64,
    '#description' => t('Enter title'),
  );
  $form['extendform']['subject'] = array(
    '#type' => 'textfield',
    '#title' => t('Subject'),
    '#size' => 30,
    '#maxlength' => 64,
    '#description' => t('Enter subject keywords'),
  );
  return $form;
}


function search_controls_content() {
  return drupal_get_form('search_controls_form');
}

function search_controls_form($form_state) {

  $form['sort'] = array(
    '#title' => t('Sort by:'),
    '#type' => 'select',
    '#default_value' => isset($_GET['sort']) ? check_plain($_GET['sort']) : '',
    '#options' => array(
      '' => t('Ranking'),
      'title_ascending' => t('Title (Ascending)'),
      'title_descending' => t('Title (Descending)'),
      'creator_ascending' => t('Creator (Ascending)'),
      'creator_descending' => t('Creator (Descending)'),
      'date_ascending' => t('Date (Ascending)'),
      'date_descending' => t('Date (Descending)')
    ),
    '#description' => t('Set sort order for search result'),
  );

  $form['size'] = array(
    '#title' => t('Results on page:'),
    '#type' => 'radios',
    '#default_value' => isset($_GET['size']) ? (int)$_GET['size'] : '10',
    '#options' => array(
      '10' => t('10'),
      '25' => t('25'),
      '50' => t('50')
    ),
    '#description' => t('Set number of records shown'),
  );

  return $form;
}


/**
 * Process a block search form submission.
 */
function ting_search_submit($form, &$form_state) {
  $controls = array();
  // The search form relies on control of the redirect destination for its
  // functionality, so we override any static destination set in the request,
  // for example by drupal_access_denied() or drupal_not_found()
  // (see http://drupal.org/node/292565).
  if (isset($_GET['destination'])) {
    unset($_GET['destination']);
  }

  $form_id = $form['form_id']['#value']; // 'search_block_form'
  $terms = $form_state['values'][$form_id];
  $fields = array();
  $args = array();

  $s = $form_state['values']['creator'];
  if ( $s != "" ) {
    $args['creator'] = $s;
    $fields[] = sprintf('%s=%s', variable_get('ting_search_extendform_creator_index', 'dc.creator'), $s);
  }

  $s = $form_state['values']['title'];
  if ( $s != "" ) {
    $args['title'] = $s;
    $fields[] = sprintf('%s=%s', variable_get('ting_search_extendform_title_index', 'dc.title'), $s);
  }

  $s = $form_state['values']['subject'];
  if ( $s != "" ) {
    $args['subject'] = $s;
    $fields[] = sprintf('%s=%s', variable_get('ting_search_extendform_subject_index', 'dc.subject'), $s);
  }

  $q = implode(' AND ', $fields);
  if ($q == '') {
    $q = $terms;
  }
  elseif ($terms != '') {
    $q = sprintf('%s AND (%s)', $terms, $q);
  }

  $s = $form_state['values']['sort'];
  if ( $s != "" ) {
    $controls['sort'] = $s;
  }

  $s = $form_state['values']['size'];
  if ( $s != "" ) {
    $controls['size'] = $s;
  }


  // Check to see if the form was submitted empty.
  // If it is empty, display an error message.
  // (This method is used instead of setting #required to TRUE for this field
  // because that results in a confusing error message.  It would say a plain
  // "field is required" because the search keywords field has no title.
  // The error message would also complain about a missing #title field.)
  if ($q == '') {
    form_set_error('keys', t('Please enter some keywords.'));
  }
  $search_info = array();
  $request_path = explode('/', request_path());

  if ($request_path[0] != 'search' || !isset($request_path[1])) {
    $search_info = search_get_default_module_info();
  }
  else {
    foreach (search_get_info() as $search_engine) {
      if ($search_engine['path'] == $request_path[1]) {
        $search_info = $search_engine;
        break;
      }
    }
  }
  if (!empty($search_info['path']) && in_array($search_info['module'], variable_get('search_active_modules', array()))) {
    $form_state['redirect'] = FALSE;
    $url = 'search/' . $search_info['path']. '/' . trim($q);
    drupal_goto($url, array('query' => $controls));
  }
  else {
    form_set_error(NULL, t('Search is currently disabled.'), 'error');
  }
}

