<?php

class DingFacetbrowser extends DrupalWebTestCase {

  public function getInfo() {
    return array(
      'name' => t('Ding Facetbrowser'),
      'description' => t('Tests for the Ding Facetbrowser module'),
      'group' => 'Ding!',
    );
  }

  public function setUp() {
    parent::setUp('ting', 'ding_facetbrowser', 'search', 'ting_search');
    variable_set('ting_agency', '721700');
    variable_set('ting_search_url', 'http://opensearch.addi.dk/0.14/');
    variable_set('ting_scan_url', 'http://openscan.addi.dk/1.5/');
    variable_set('ting_spell_url', 'http://openspell.addi.dk/1.2/');
    variable_set('ting_recommendation_url', 'http://openadhl.addi.dk/1.1/');
    variable_set('search_active_modules', array('node' => 'node', 'ting_search' => 'ting_search'));
    variable_set('search_default_module', 'ting_search');
    variable_set('ting_enable_logging', 1);
    $this->web_user = $this->drupalCreateUser(array('administer search', 'administer blocks', 'search content', 'create page content'));
  }

  public function testFacetModules() {
    $this->drupalLogin($this->web_user);
    // Check if search module is installed
    $exists = module_exists('search');
    $this->assertTrue($exists, 'Search is enabled');

    // Check if ding_facetbrowser module is installed
    $exists = module_exists('ding_facetbrowser');
    $this->assertTrue($exists, 'Ding Facetbrowser is enabled');

    // Check if the facetbrowser block is available
    $this->drupalGet('admin/structure/block');
    $this->assertRaw('Facet browser', 'The facetbrowser block is available');

    $this->drupalPost('admin/structure/block', array('blocks[ding_facetbrowser_facetbrowser][region]' => 'sidebar_first'), t('Save blocks'));
    $this->assertFieldByName('blocks[ding_facetbrowser_facetbrowser][region]', 'sidebar_first', t('Configurable text block is enabled in first sidebar successfully verified.') );

    // Create a page node containing the text 'harry'
    $node_info = array(
      'title' => 'test node',
      'body[und][0][value]' => 'Harry potter rocks',
    );

    $this->drupalPost('node/add/page', $node_info, t('Save'));

    // Execute cron to update search index
    $this->cronRun();

    // Search the site for harry
    $this->drupalGet('search/node/harry');
    $this->assertText('Harry potter rocks', 'Search for "Harry potter rocks" in drupal - complete');

  }
}


