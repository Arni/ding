<?php
/**
 * @file
 * Code for the Ding eKurser feature.
 */

include_once 'ding_ekurser.features.inc';

/**
 * Implements hook_form_alter().
 *
 * Set search type to 'film (net)' and hide facet type from facet browser.
 * Also hide certain fields via css.
 */
function ding_ekurser_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id != 'ding_facetbrowser_form' || strpos($form['#action'], '/ekurser') !== 0) {
    return;
  }

  drupal_add_css(drupal_get_path('module', 'ding_ekurser') . '/ding_ekurser.css', 'file');
}

/**
 * Implements hook_search_info().
 */
function ding_ekurser_search_info() {
  return array(
    'title' => t('Ding eKurser'),
    'conditions_callback' => 'ding_ekurser_conditions_callback',
  );
}

/**
 * Implements hook_search_execute().
 *
 * We don't make our own search, but call ting_search.
 */
function ding_ekurser_search_execute($keys = NULL, $conditions = NULL) {
  return ting_search_search_execute($keys, $conditions);
}

/**
 * Search conditions callback.
 *
 * Use ting_search's conditions callback and add default sort.
 */
function ding_ekurser_conditions_callback($keys) {
  $conditions = ting_search_conditions_callback($keys);
  if (empty($conditions['sort'])) {
    $conditions['sort'] = 'acquisitionDate_descending';
  }
  return $conditions;
}

/**
 * Set default sort options.
 *
 * @return array
 *   Returns an array of sort options.
 */
function ding_ekurser_search_sort_options() {
  $options = array(
    'title_ascending' => t('Title (Ascending)'),
    'title_descending' => t('Title (Descending)'),
    'acquisitionDate_ascending' => t('Acquisition date (Ascending)'),
    'acquisitionDate_descending' => t('Acquisition date (Descending)'),
  );

  // Add label to the front of the options.
  foreach ($options as $key => $option) {
    $options[$key] = t('Sort by: !sort', array('!sort' => $option));
  }

  return $options;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Change sort options when we're on the overview of eKurser.
 */
function ding_ekurser_form_ting_search_sort_form_alter(&$form, &$form_state, $form_id) {
  if (strpos($form['#action'], '/ekurser') !== 0) {
    return;
  }

  // Set our own sorting options and set default sort, if it's not set.
  $form['sort']['#options'] = ding_ekurser_search_sort_options();
  if (empty($form['sort']['#default_value'])) {
    $form['sort']['#default_value'] = 'acquisitionDate_descending';
  }
}
