<?php
/**
 * @file
 * Availability information for ding objects.
 */

/**
 * Implements hook_menu().
 */
function ding_availability_menu() {
  $items['ding_availability/item'] = array(
    'title' => 'Availability status',
    'page callback' => 'ding_availability_js',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 *
 */
function ding_availability_js($provider_ids) {
  drupal_json_output(ding_availability_items(explode(',', $provider_ids)));
}

/**
 *
 */
function ding_availability_items($provider_ids) {
  $items = ding_provider_invoke('availability', 'items', $provider_ids);
  foreach ($items as $item) {
    $item += array(
      'reservable' => FALSE,
      'available' => FALSE,
    );
  }

  return $items;
}

/**
 * Implements hook_entity_view().
 */
function ding_availability_ding_entity_view($entity, $view_mode, $langcode = NULL) {
  // dpm(ding_provider_invoke('availability', 'items', array($entity->provider_id)));

  $entity->content['overview']['right'] = array(
    '#markup' => '<div class="availability-' . $entity->provider_id. '">wolla</div>',
    '#weight' => 10,
    '#attached' => array(
      'js' => array(
        drupal_get_path('module', 'ding_availability') . '/ding_availability.js' => array(
          'type' => 'file',

        ),
        array('data' => array('ding_availability' => array($entity->provider_id => array('availability-' . $entity->provider_id))), 'type' => 'setting'),
      ),
    ),
  );
}
