<?php
/**
 * @file
 * Implements a common interface to backend providers.
 */

/**
 * Implements hook_menu().
 */
function ding_provider_menu() {
  $items['admin/config/ding/provider'] = array(
    'title' => 'Ding provider',
    'page callback' => 'ding_provider_admin_overview',
    'access arguments' => array('administer ding provider'),
    'file' => 'ding_provider.admin.inc'
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function ding_provider_permission() {
  return array(
    'administer ding provider' => array(
      'title' => t('Administer Ding provider'),
    ),
  );
}

/**
 * Invoke a provider hook.
 */
function ding_provider_invoke() {
  $args = func_get_args();
  $type = array_shift($args);
  $hook = array_shift($args);

  $provider = _ding_provider_get_provider($type);
  if ($provider) {
    $function = $provider['module'] . '_' . (isset($provider['prefix']) ? $provider['prefix'] . '_' : '') . $hook;

    if (isset($provider['file'])) {
      require_once DRUPAL_ROOT . '/' . $provider['file'];
    }

    if ($function) {
      return call_user_func_array($function, $args);
    }
    // Trigger an error. This might be a module attempting to use a wrong
    // hook, or an improperly implemented plugin. In either case, it's
    // programmer error.
    trigger_error(t('Ding @type provider (%module module) does not implement %function', array('@type' => $type, '%function' => $hook, '%module' => $provider['module'])), E_USER_ERROR);
  }
  else {
    watchdog('ding_provider', 'Provider module not configured for provider type %type.', array('%type' => $type), WATCHDOG_ERROR);
  }
}

/**
 * Returns the given provider.
 */
function _ding_provider_get_provider($type = NULL) {
  static $providers;
  if (!isset($providers)) {
    $providers = array();
    foreach (module_implements('ding_provider') as $module) {
      $module_provides = module_invoke($module, 'ding_provider');
      foreach ($module_provides as $name => $module_provider) {
        $module_provider['module'] = $module;
        $providers[$name] = $module_provider;
      }
    }
  }

  if (!$type) {
    return $providers;
  }

  if (isset($providers[$type])) {
    return $providers[$type];
  }
  return NULL;
}
